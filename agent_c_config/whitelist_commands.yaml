git:
  description: "Read-only/metadata git operations (no mutations)."
  subcommands:
    status:  { flags: ["--porcelain", "-s", "-b", "--no-color"], timeout: 20 }
    log:     { flags: ["--oneline","--graph","--decorate","-n","-p", "--no-color"] }
    show:    { flags: ["--name-only","--stat","-p", "--no-color"] }
    diff:    { flags: ["--name-only","--stat","--cached","-p", "--no-color"] }
    add: { "flags": [ ] }
    restore: { "flags": [ "--staged" ] }
    reset: { "flags": [ "--hard", "--soft", "--mixed" ] }
    checkout: { "flags": [ "-b", "--" ] }
    switch: { "flags": [ "-c", "-" ] }  # not git -c; this is switch -c (create)
    branch: { "flags": [ "-a", "-vv", "-d", "-D" ] }
    stash: { "flags": [ "list", "push", "pop", "apply", "drop", "clear" ] }
    commit: { "flags": [ "-m", "--amend", "--no-verify" ] }
    rev-parse: { "flags": [ "--abbrev-ref", "--short", "HEAD", "--verify" ] }
    ls-files: { "flags": [ "--exclude-standard", "--others", "--cached" ] }
  deny_global_flags: ["-c","--exec-path","--help","-P"]
  safe_env:
    GIT_TERMINAL_PROMPT: "0"
    GIT_CONFIG_NOSYSTEM: "1"
    GIT_CONFIG_GLOBAL: "/dev/null"
    GIT_ALLOW_PROTOCOL: "https,file"
  env_overrides:
    # Token Optimizations
    GIT_PAGER: "cat"          # disable pager (no escape codes from 'less -R')
    CLICOLOR: "0"               # disable colorization
    TERM: "dumb"               # discourages color/TTY tricks
  default_timeout: 30

pytest:
  # PytestCommandValidator uses SAFE_FLAGS; this sets defaults/timeouts or env overrides
  flags: [ "-q","--maxfail","--disable-warnings","--color","--no-header","--no-summary","--tb" ]
  allow_test_paths: true  # Enable workspace-relative test paths and file:line references
  suppress_success_output: true  # Test runs can be verbose, just show success/failure
  default_timeout: 120
  env_overrides:
    PYTHONDONTWRITEBYTECODE: "1"
    PYTEST_ADDOPTS: "-q --color=no --maxfail=1" # quiet + no ANSI + stop early
    PYTEST_DISABLE_PLUGIN_AUTOLOAD: "1"         # avoids third-party plugin noise
    PYTHONWARNINGS: "ignore"                    # ignore depreciation warnings from test runs

# ---- OS basics ----
which:
  validator: os_basic
  flags: ["-a","--version"]
  default_timeout: 5

where:               # Windows equivalent of 'which'
  validator: os_basic
  flags: ["/r"]      # (optional) supports scanning a dir; consider omitting for safety
  default_timeout: 5

whoami:
  validator: os_basic
  flags: []          # (Windows 'whoami' has flags like /USER; add if needed)
  default_timeout: 5

echo:
  validator: os_basic
  flags: ["--help","-n","-e"]   # keep minimal; shell redirection is ignored under shell=False
  default_timeout: 5
  suppress_success_output: true  # For testing suppression feature

# Windows uses find for inside of files, but *nix find is for filesystem searching.  Disabling for now.
#find:
#  validator: os_basic
#  flags: ["-name","-maxdepth","-type","-mtime","-not","-path","-print"]
#  deny_tokens: ["-exec","-ok","-delete","-fdelete","-execdir","-prune"]
#  default_timeout: 10

# On Windows you may prefer 'findstr' (text search) instead of 'find'
#findstr:
#  validator: os_basic
#  flags: ["/I","/N","/R","/S"]  # be careful with recursive /S
#  default_timeout: 10

# ---- Language-specific ----

node:
  validator: node
  flags:
    "--test": { suppress_success_output: true, allow_test_mode: true }
    "-v": {}
    "--version": {}
    "--help": {}
    "-c": { suppress_success_output: true, allow_test_mode: true }
    "--test-reporter": { suppress_success_output: true, allow_test_mode: true }
    "--test-name-pattern": { suppress_success_output: true, allow_test_mode: true }
  allow_script_paths: false # Enable workspace-relative test paths for `node --test`
#  allowed_entrypoints: # uncomment and update to restrict allowed script entrypoints
#    - scripts/maintenance.js
#    - tools/migrate.cjs
  deny_global_flags: ["-e","--eval","-p","--print"]
  default_timeout: 5
  env_overrides:
    NODE_DISABLE_COLORS: "1"
    FORCE_COLOR: "0"
nodejs:
  validator: node
  flags: [ "-v","--version","--help" ]
  deny_global_flags: [ "-e","--eval","-p","--print" ]
  default_timeout: 5
  env_overrides:
    NODE_DISABLE_COLORS: "1"
    FORCE_COLOR: "0"

npm:
  validator: npm
  root_flags: ["-v","--version","--help"]
  subcommands:
      view:   { allowed_flags: ["--json"] }
      list:   { allowed_flags: ["--depth","--json"] }
      ping:   { allowed_flags: [] }
      outdated: { allowed_flags: [] }
      test:   { allowed_flags: [] }
      ls:    { allowed_flags: ["--depth","--json","--long"] }

      # Only allow "npm config get <key>"
      config:
        get_only: true
        allowed_flags: []       # keep empty; we gate on 'get'

      # --- Scripts (ALLOWLIST) ---
      run:
        build: { suppress_success_output: true }
        test: { suppress_success_output: true }
        "test:run": { suppress_success_output: true }
        typecheck: { suppress_success_output: true }
        lint: { }
        "lint:fix": { }
        format: { }  # Inherit defaults
        deny_args: false
        allow_test_paths: true  # Enable workspace-relative test paths for npm run scripts
        suppress_success_output: true  # Build/test scripts can be noisy

      # --- Safe, lockfile-based install ---
      ci:
        enabled: true
        require_no_packages: true
        require_flags: ["--ignore-scripts"]
        allowed_flags: ["--ignore-scripts","--no-audit","--no-fund","--prefer-offline","--cache"]

      install:
        enabled: false
        require_no_packages: true
        require_flags: ["--ignore-scripts"]
        allowed_flags: ["--ignore-scripts","--no-audit","--no-fund","--prefer-offline","--cache"]

  # keep ‘i’ denied unless you want it—the validator aliases it to 'install'
  deny_subcommands: ["exec","publish","update","audit","ci-info","token","login","adduser","whoami","pack","link","unlink"]

  default_timeout: 120
  env_overrides:
    NPM_CONFIG_COLOR: "false"       # npm itself: no color
    NPM_CONFIG_PROGRESS: "false"    # no progress bars
    NPM_CONFIG_LOGLEVEL: "warn"     # or "error" to be even quieter
    FORCE_COLOR: "0"                # chalk/colorette/etc. honor this
    NODE_DISABLE_COLORS: "1"        # belt-and-suspenders for some libs
    CI: "1"                         # many CLIs reduce interactivity/spinners
    NPM_CONFIG_FUND: "false"
    NPM_CONFIG_AUDIT: "false"
    NPM_CONFIG_UPDATE_NOTIFIER: "false"
    NPM_CONFIG_PREFIX: ".npm-prefix"
    NPM_CONFIG_CACHE: ".npm-cache"
    # ensure Windows can resolve .cmd if the parent env omitted it
    PATHEXT: ".COM;.EXE;.BAT;.CMD"

pnpm:
  validator: pnpm
  root_flags: ["-v","--version","--help"]
  global_flags_before_subcommand:
    # boolean means “takes the value next”
    # adding global flags here allows us to use commands like 'pnpm --filter @agentc/realtime-ui test' before the subcommand
    # So, setting --filter: true means filter on @agentc/realtime-ui, and false means no value allowed
    "--filter": true
    "--silent": false
    "-r": false            # --recursive
  subcommands:
    # This is in effect allowing us to call 'pnpm run build' or 'pnpm build' - it's double mapping, but pnpm allows both, so here we are.
    # This does mean you can have separate policies for 'pnpm run <script>' and 'pnpm <script>' if you want.
    # FYI, allowed_flags: [] means no flags allowed, not "all flags allowed". If you want to allow all flags, remove allowed_flags empty array.
    # allow_test_paths: true enables workspace-relative test paths for scripts, guards against arbitrary file selectors
    # deny_args: false allows arbitrary args to be passed to the script (e.g., 'pnpm test -- --watch')
    # suppress_success_output: true reduces noise from successful runs; false shows full output
    run:
      scripts:
        build: { suppress_success_output: true,  allow_test_mode: true, deny_args: false }
        test: { allowed_flags: [], deny_args: false, allow_test_paths: true, suppress_success_output: true }
        "test:run": { allowed_flags: [], deny_args: false, allow_test_paths: true, suppress_success_output: true }
        "test:debug": { allowed_flags: [], deny_args: false, allow_test_paths: true, suppress_success_output: false }
        "type-check": { allowed_flags: [], suppress_success_output: false, allow_test_mode: true, deny_args: false }
        "typecheck": { allowed_flags: [ ], suppress_success_output: false, allow_test_mode: true, deny_args: false }
        "type_check": { allowed_flags: [ ], suppress_success_output: false, allow_test_mode: true, deny_args: false }
        "test:coverage": { allowed_flags: [], deny_args: false, allow_test_paths: true, suppress_success_output: false }
        "clean": { suppress_success_output: false, allow_test_mode: true, deny_args: false }
        "install:clean": { suppress_success_output: false, allow_test_mode: true, deny_args: false }
    view: { allowed_flags: ["--json"] }
    list: { allowed_flags: ["--depth","--json","--long"] }
    ping: { allowed_flags: [] }
    outdated: { allowed_flags: [] }
    test: { allowed_flags: [], deny_args: false, allow_test_paths: true, suppress_success_output: true }
    "test:run": { allowed_flags: [], deny_args: false, allow_test_paths: true, suppress_success_output: true }
    "test:watch": { allowed_flags: [], deny_args: false, allow_test_paths: true, suppress_success_output: true }
    "test:coverage": { allowed_flags: [], deny_args: false, allow_test_paths: true, suppress_success_output: false }
    "test:ui": { allowed_flags: [], deny_args: false, allow_test_paths: true, suppress_success_output: true }
    "test:debug": { allowed_flags: [], deny_args: false, allow_test_paths: true, suppress_success_output: true }
    "clean": { suppress_success_output: false, allow_test_mode: true, deny_args: false }
    "type-check": { allowed_flags: [], suppress_success_output: false, allow_test_mode: true, deny_args: false }
    "typecheck": { allowed_flags: [], suppress_success_output: false, allow_test_mode: true, deny_args: false }
    "type_check": { allowed_flags: [], suppress_success_output: false, allow_test_mode: true, deny_args: false }
    ls: { allowed_flags: [] }
    build: { allowed_flags: [], suppress_success_output: true }
    why: { allowed_flags: ["--json","--long"] }
    licenses: { allowed_flags: ["--json","--long"] }
    lint: { allowed_flags: ["--fix"], deny_args: false, allow_test_paths: true }
    "lint:fix": { allowed_flags: [], deny_args: false, allow_test_paths: true }
    "install:clean": { suppress_success_output: false, allow_test_mode: true, deny_args: false }

    # Only allow "pnpm config get <key>"
    config:
      get_only: true
      allowed_flags: []       # keep empty; we gate on 'get'

    # --- Safe, lockfile-based install ---
    install:
      enabled: true
      require_no_packages: true
      require_flags: ["--ignore-scripts"]
      allowed_flags: ["--ignore-scripts","--prefer-offline","--frozen-lockfile","--reporter","--dev","--prod"]
      suppress_success_output: true

  # pnpm doesn't have ci command like npm, but has similar restrictions
  # keep 'i' and 'add' denied unless you want them—the validator aliases them to 'install'
  deny_subcommands: ["exec","publish","update","audit","login","adduser","whoami","pack","link","unlink","patch","patch-commit"]

  default_timeout: 120
  env_overrides:
    PNPM_CONFIG_COLOR: "false"      # pnpm itself: no color
    PNPM_CONFIG_PROGRESS: "false"   # no progress bars
    PNPM_CONFIG_LOGLEVEL: "warn"    # or "error" to be even quieter
    CI: "1"                         # many CLIs reduce interactivity/spinners
    PNPM_CONFIG_FUND: "false"
    PNPM_CONFIG_UPDATE_NOTIFIER: "false"
    # ensure Windows can resolve .cmd if the parent env omitted it
    PATHEXT: ".COM;.EXE;.BAT;.CMD"

npx:
  validator: npx
  packages:
    typescript: { suppress_success_output: true }   # tsc can be verbose
    "@angular/cli": { suppress_success_output: true }  # ng build is noisy
    webpack: { suppress_success_output: true }      # webpack output is verbose
    jest: { suppress_success_output: true }         # test output can be noisy
    eslint: { }                                     # Keep linter output visible
    prettier: { }                                   # Keep formatter output visible
    serve: { }                                      # Keep server startup messages
    create-react-app: {}
    create-next-app: {}
    "@vue/cli": {}
    ts-node: { suppress_success_output: true }      # ts-node can be verbose
    mocha: { suppress_success_output: true }        # test output can be noisy
    vite: { suppress_success_output: true }         # build output can be verbose
    rollup: { suppress_success_output: true }       # build output can be verbose
    parcel: { suppress_success_output: true }       # build output can be verbose
    "http-server": {}                               # Keep server startup messages
  command_aliases:
    typescript: [ "tsc" ]
  flags:
    - "--yes"
    - "-y"
    - "--package"
    - "-p"
    - "--call"
    - "-c"
    - "--shell"
    - "-s"
    - "--shell-auto-fallback"
    - "--ignore-existing"
    - "--quiet"
    - "-q"
    - "--npm"
    - "--node-options"
  default_timeout: 120
  env_overrides:
    NPM_CONFIG_COLOR: "false"
    NPM_CONFIG_PROGRESS: "false"
    FORCE_COLOR: "0"
    NODE_DISABLE_COLORS: "1"
    CI: "1"
    NPM_CONFIG_FUND: "false"
    NPM_CONFIG_AUDIT: "false"
    NPM_CONFIG_UPDATE_NOTIFIER: "false"

lerna:
  validator: lerna
  flags: ["--version", "-v", "--help", "-h", "--loglevel", "--concurrency", "--scope", "--ignore", "--include-dependencies", "--include-dependents", "--since"]
  subcommands:
    list:
      flags: ["--json", "--ndjson", "--parseable", "-p", "--long", "-l", "--all", "-a", "--graph", "--toposort"]
      timeout: 30
    info:
      flags: ["--json"]
      timeout: 15
    bootstrap:
      flags: ["--hoist", "--strict", "--nohoist", "--ignore-scripts", "--ignore-prepublish", "--ignore-engines", "--npm-client", "--use-workspaces"]
      timeout: 300
    clean:
      flags: ["--yes", "-y"]
      timeout: 60
    ls:
      flags: ["--json", "--ndjson", "--parseable", "-p", "--long", "-l", "--all", "-a", "--graph", "--toposort"]
      timeout: 30
    changed:
      flags: ["--json", "--ndjson", "--parseable", "-p", "--long", "-l", "--all", "-a", "--graph", "--toposort", "--include-merged-tags"]
      timeout: 30
    diff:
      flags:
        - "--ignore-changes"
      timeout: 45
    run:
      flags: ["--npm-client", "--stream", "--parallel", "--bail", "--no-bail", "--no-prefix", "--concurrency", "--concurrency=1"]
      allowed_scripts: [ "build","test","lint","format","typecheck", 'lint:fix', 'test:run' ]
      allow_test_paths: true
      deny_args: false
      timeout: 300
      suppress_success_output: true  # Build/test scripts through lerna can be very verbose
    version:
      flags: ["--conventional-commits", "--changelog-preset", "--exact", "--force-publish", "--git-remote", "--create-release", "--dry-run", "--json", "--loglevel", "--no-changelog", "--no-commit-hooks", "--no-git-tag-version", "--no-push", "--preid", "--sign-git-commit", "--sign-git-tag", "--tag-version-prefix", "--yes", "-y"]
      timeout: 120
  deny_subcommands: ["publish", "exec", "import", "create", "add", "link"]
  default_timeout: 180
  env_overrides:
    LERNA_DISABLE_PROGRESS: "1"
    NPM_CONFIG_COLOR: "false"
    NPM_CONFIG_PROGRESS: "false"
    FORCE_COLOR: "0"
    NODE_DISABLE_COLORS: "1"
    CI: "1"

dotnet:
  validator: dotnet
  subcommands:
    --info: { flags: [ ] }
    --list-sdks: { flags: [ ] }
    --list-runtimes: { flags: [ ] }

    restore:
      flags: [ "--locked-mode","--configfile","--source","--verbosity","-v","--nologo" ]
      require_flags:
        --locked-mode: true
        --nologo: true
        --verbosity: [ "quiet","minimal" ]   # enforce locked dependency graph

    build:
      flags: [ "--configuration","-c","--no-restore","--nologo","--verbosity","-v" ]
      # If you want to *require* separate restore/build phases, uncomment:
      # require_flagsl: ["--no-restore"]
      require_flags:
        --nologo: true
        --verbosity: [ "quiet","minimal" ] # enforce quiet, no-logo builds
      suppress_success_output: true  # Build output can be verbose

    test:
      flags: [ "--configuration","-c","--no-build","--nologo","--verbosity","-v","--filter", "--list-tests", "--settings", "--results-directory", "--test-adapter-path", "--diag", "--logger" ]
      allow_project_paths: true # allow typical csproj/sln positionals without enabling arbitrary file selectors
      allow_test_paths: false  # Can enable workspace-relative test paths for dotnet test - prefer using --filter instead
      require_flags:
        --no-build: true
        --nologo: true
        --verbosity: [ "minimal","quiet" ]
        --logger: "console;verbosity=minimal"
      suppress_success_output: true  # Test output can be verbose

  deny_subcommands: [ "run","publish","tool","new","pack","clean","nuget","workload" ]
  default_timeout: 300
  env_overrides:
    DOTNET_CLI_TELEMETRY_OPTOUT: "1"
    DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"
    DOTNET_NOLOGO: "1"
    NUGET_PACKAGES: ".nuget/packages"
    # Generic no-color hints:
    CLICOLOR: "0"
    TERM: "dumb"
    # Stable, English output (helps tokenization & parsing):
    DOTNET_CLI_UI_LANGUAGE: "en-US"

# ---- PowerShell (HIGHLY RESTRICTED) ----
# PowerShell is extremely dangerous and powerful. This configuration only allows
# safe, read-only information gathering cmdlets with maximum security restrictions.
# All script execution, file operations, and dangerous cmdlets are blocked.
# This is not set up to suppress output as PowerShell cmdlets are typically used for information gathering.
powershell: &powershell_common
  validator: powershell
  description: "Execute safe, read-only PowerShell cmdlets for information gathering only"
  rationale: |
    PowerShell is extremely powerful and can execute arbitrary code, access system APIs,
    modify files, and perform dangerous operations. This policy implements maximum security
    restrictions:
    - Only allows whitelisted safe cmdlets (Get-*, Format-*, Out-*, etc.)
    - Blocks all script execution (-Command, -File, -EncodedCommand)
    - Forces Restricted execution policy
    - Enables lockdown mode and constrained language mode
    - Blocks dangerous patterns and cmdlets
    - Only permits read-only information gathering operations
  flags: ["-Help", "-?", "-NoProfile", "-nop", "-NonInteractive", "-noni", "-NoLogo", "-nol"]
  deny_global_flags: [
    "-Command", "-c", "-EncodedCommand", "-enc", "-e", "-File", "-f",
    "-ExecutionPolicy", "-ep", "-ex", "-WindowStyle", "-w", "-Sta", "-Mta",
    "-Version", "-v", "-PSConsoleFile", "-ConfigurationName",
    "-InputFormat", "-if", "-OutputFormat", "-of"
  ]
  require_flags: ["-NoProfile", "-NonInteractive"]
  # Whitelist of safe, read-only cmdlets allowed for information gathering
  safe_cmdlets: [
    # Information gathering cmdlets
    "get-process", "get-service", "get-childitem", "get-location", "get-date",
    "get-host", "get-culture", "get-uiculture", "get-executionpolicy",
    "get-psdrive", "get-item", "get-itemproperty", "get-content",
    "get-variable", "get-alias", "get-command", "get-module",
    "get-pssession", "get-history", "get-member", "get-help",
    "get-computerinfo", "get-timezone", "get-uptime",
    # Safe formatting and output cmdlets
    "format-table", "format-list", "format-wide", "format-custom",
    "out-string", "out-null", "out-default",
    "select-object", "where-object", "sort-object", "group-object",
    "measure-object", "compare-object",
    # Safe utility cmdlets
    "write-output", "write-host", "write-verbose", "write-debug",
    "test-path", "resolve-path", "split-path", "join-path", "convert-path"
  ]
  # Regex patterns that indicate dangerous operations (case-insensitive)
  dangerous_patterns: [
    "invoke-expression", "invoke-command", "iex\\s", "icm\\s",
    "\\$\\(", "`", "&\\s", "\\.\\s",  # Command substitution, backticks, call operator, dot sourcing
    "start-process", "new-object", "add-type",
    "\\[system\\.", "\\[reflection\\.",
    "downloadstring", "downloadfile", "webrequest", "webclient",
    "invoke-webrequest", "invoke-restmethod",
    "set-", "new-", "remove-", "clear-", "stop-", "restart-",  # Modification cmdlets
    "enable-", "disable-", "install-", "uninstall-",
    "register-", "unregister-"
  ]
  safe_env:
    PSExecutionPolicyPreference: "Restricted"
    __PSLockdownPolicy: "1"
    PSModuleAutoLoadingPreference: "None"
  env_overrides:
    PSReadlineHistorySaveStyle: "SaveNothing"
    POWERSHELL_TELEMETRY_OPTOUT: "1"
    POWERSHELL_UPDATECHECK: "Off"
    PSDisableWinRTForCurrentUser: "1"
    TERM: "dumb"
    CLICOLOR: "0"
  default_timeout: 30

# PowerShell Core (pwsh) - same restrictions as Windows PowerShell
pwsh: *powershell_common
