# HeyGen Avatar Integration Guide

This document provides detailed information about the HeyGen streaming avatar integration within the Agent C Realtime API. This integration enables interactive avatar experiences where HeyGen avatars speak the responses generated by Agent C agents.

## Overview

The HeyGen integration creates a seamless connection between Agent C's conversational AI and HeyGen's streaming avatar technology. The system manages two parallel connections:

1. **Agent C Connection**: WebSocket to Agent C Realtime API for agent communication
2. **HeyGen Connection**: Direct WebSocket/WebRTC to HeyGen's streaming infrastructure for avatar video/audio

## HeyGen API Architecture

### Token Flow

HeyGen uses a two-stage authentication system:

1. **API Key â†’ Access Token**: Server calls `/v1/streaming.create_token` with API key to get access token
2. **Access Token â†’ Session Operations**: Access token is used for all streaming operations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent C Server  â”‚      â”‚   HeyGen API    â”‚      â”‚     Client     â”‚
â”‚                 â”‚      â”‚               â”‚      â”‚               â”‚
â”‚ 1. API Key      â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ create_token   â”‚      â”‚               â”‚
â”‚ 2. Access Token â”‚â—€â”€â”€â”€â”€â”€â”€â”‚               â”‚      â”‚               â”‚
â”‚ 3. Session Data â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ streaming.new  â”‚      â”‚               â”‚
â”‚ 4. Start Avatar â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ streaming.startâ”‚      â”‚               â”‚
â”‚                 â”‚      â”‚               â”‚      â”‚               â”‚
â”‚ Return session  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Direct connect â”‚
â”‚ data to client  â”‚                     â”‚ to HeyGen WS   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Insights

- **Access Token = Session Token**: The access token from `create_token` serves as both authentication and session identifier
- **One-Time Use**: Each access token is tied to a single streaming session
- **Direct Client Connection**: Clients connect directly to HeyGen using session data from Agent C
- **MediaStream**: HeyGen provides WebRTC MediaStream, not video URLs

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚      â”‚                  â”‚      â”‚                   â”‚
â”‚   Client App    â”‚â—„â”€â”€â”€â”€â–ºâ”‚  Agent C API     â”‚â—„â”€â”€â”€â”€â–ºâ”‚  Agent Runtime    â”‚
â”‚                 â”‚      â”‚                  â”‚      â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                           â”‚
      â”‚ HeyGen WebSocket          â”‚ HeyGen Client
      â”‚                           â”‚
      â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚      â”‚                  â”‚
â”‚  HeyGen Stream  â”‚â—„â”€â”€â”€â”€â–ºâ”‚  HeyGen API      â”‚
â”‚                 â”‚      â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Avatar Session Lifecycle

### 1. Avatar Selection

When a client selects an avatar, the following process occurs:

```javascript
// Client sends avatar selection
{
  "type": "set_avatar",
  "avatar_id": "anna_public_3_20240108",
  "quality": "medium",
  "video_encoding": "VP8"
}
```

**Note**: The actual HeyGen API flow involves:

1. Server calls `/v1/streaming.create_token` (with API key) â†’ gets access token
2. Server calls `/v1/streaming.new` (with access token) â†’ creates session
3. Server calls `/v1/streaming.start` (with access token) â†’ starts avatar
4. Server returns session data to client for direct HeyGen connection

### 2. HeyGen Session Creation

The Agent C API automatically:

1. Generates a HeyGen access token using API key (`/v1/streaming.create_token`)
2. Creates a new HeyGen streaming session (`/v1/streaming.new`)
3. Starts the avatar session (`/v1/streaming.start`)
4. Returns complete session data to the client for direct HeyGen connection

### 3. Avatar Connection Response

The client receives avatar session data:

```javascript
{
  "type": "avatar_connection_changed",
  "avatar_session": {
    "session_id": "heygen_session_abc123",
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "url": "https://api.heygen.com",
    "realtime_endpoint": "wss://api.heygen.com",
    "session_duration_limit": 1800,
    "is_paid": true,
    "ice_servers": [...],
    "avatar_id": "anna_public_3_20240108",
    "quality": "medium",
    "video_encoding": "VP8"
  }
}
```

## Avatar Configuration Options

### Quality Settings

| Quality  | Description                         | Bandwidth | Use Case                       |
| -------- | ----------------------------------- | --------- | ------------------------------ |
| `low`    | Lower resolution, minimal bandwidth | ~500 Kbps | Mobile, limited bandwidth      |
| `medium` | Balanced quality and performance    | ~1 Mbps   | Standard web applications      |
| `high`   | High resolution, best quality       | ~2+ Mbps  | Desktop, high-quality displays |

### Video Encoding

| Encoding | Description                        | Compatibility | Performance |
| -------- | ---------------------------------- | ------------- | ----------- |
| `VP8`    | WebRTC standard, broad support     | Excellent     | Good        |
| `H264`   | Industry standard, high efficiency | Good          | Excellent   |

**Recommendation**: Use `VP8` for maximum compatibility, `H264` for better performance on supported devices.

## Special Text Handling

### Text Delta Caching

The Agent C API implements special text handling for avatar speech:

1. **Caching**: Text deltas are accumulated until a newline (`\n`) is encountered
2. **Speech Trigger**: Complete sentences are sent to HeyGen for avatar speech
3. **Client Update**: Enhanced text deltas are sent to clients for display synchronization

```javascript
// Instead of many small deltas like:
{"type": "text_delta", "content": "Hello"}
{"type": "text_delta", "content": " there"}
{"type": "text_delta", "content": "!"}

// Clients receive coherent blocks like:
{"type": "text_delta", "content": "Hello there!\n"}
```

### Benefits of Text Caching

- **Coherent Speech**: Avatars speak complete thoughts rather than fragmented words
- **Natural Timing**: Speech synchronizes with complete sentences
- **Better UX**: Clients can display text in sync with avatar speech
- **Reduced API Calls**: Fewer HeyGen API requests

## Thought Handling and Engagement

### Thinking Messages

When an agent begins thinking (first `thought_delta` received), the avatar automatically says a "thinking" message to maintain user engagement:

```javascript
// When this event is received:
{
  "type": "thought_delta",
  "content": "I need to consider the user's question...",
  "role": "assistant (thought)"
}

// The avatar automatically speaks: "Let me think about that..."
```

### Customizing Thinking Messages

The default thinking message can be customized by modifying the `avatar_think_message` property:

```javascript
// In the RealtimeBridge implementation
get avatar_think_message() {
  return "Let me think about that..."; // Customize this message
}
```

### Thinking Behavior

- **First Thought Only**: Only the first thought delta triggers the thinking message
- **No Speech Overlap**: Thinking message doesn't interfere with actual responses
- **Visual Feedback**: Thought deltas are still sent to clients for display
- **Engagement Maintenance**: Prevents awkward silence during processing

## Client-Side HeyGen Integration

### Establishing HeyGen Connection

```javascript
// Import HeyGen SDK
import StreamingAvatar, { StreamingEvents } from '@heygen/streaming-avatar';

class HeyGenAvatarClient {
    constructor() {
        this.heygenWs = null;
        this.videoElement = null;
        this.isAvatarReady = false;
        this.streamingAvatar = null; // HeyGen SDK instance
    }

    async connectToAvatar(avatarSession) {
        // Option 1: Use HeyGen JavaScript SDK (Recommended)
        this.streamingAvatar = new StreamingAvatar({
            token: avatarSession.access_token,
            basePath: avatarSession.url
        });

        // Set up event handlers
        this.streamingAvatar.on(StreamingEvents.STREAM_READY, (event) => {
            this.setupVideoStream(event.detail);
        });

        this.streamingAvatar.on(StreamingEvents.AVATAR_START_TALKING, () => {
            this.onAvatarStartTalking();
        });

        this.streamingAvatar.on(StreamingEvents.AVATAR_STOP_TALKING, () => {
            this.onAvatarStopTalking();
        });

        // Avatar is already started by Agent C server
        // Just wait for stream ready event

        // Option 2: Direct WebSocket (Advanced)
        // const wsUrl = `wss://${new URL(avatarSession.realtime_endpoint).hostname}/v1/ws/streaming.chat?session_id=${avatarSession.session_id}&session_token=${avatarSession.access_token}`;
        // this.heygenWs = new WebSocket(wsUrl);
    }

        this.heygenWs.onmessage = (event) => {
            const data = JSON.parse(event.data);
            this.handleHeyGenEvent(data);
        };

        return new Promise((resolve) => {
            this.onAvatarReady = resolve;
        });
    }

    // Send text to avatar for speech (if needed)
    async speakText(text) {
        if (this.streamingAvatar) {
            await this.streamingAvatar.speak({ text });
        }
    }

    handleHeyGenEvent(event) {
        switch (event.type) {
            case 'stream_ready':
                this.setupVideoStream(event.detail);
                break;
            case 'avatar_start_talking':
                this.onAvatarStartTalking();
                break;
            case 'avatar_stop_talking':
                this.onAvatarStopTalking();
                break;
            case 'session_close':
                this.onSessionClose();
                break;
        }
    }

    setupVideoStream(mediaStream) {
        this.videoElement = document.getElementById('avatar-video');
        this.videoElement.srcObject = mediaStream; // MediaStream, not URL
        this.videoElement.onloadedmetadata = () => {
            this.videoElement.play();
            this.isAvatarReady = true;
            this.onAvatarReady?.();
        };
    }

    onAvatarStartTalking() {
        // Visual feedback that avatar is speaking
        this.videoElement?.classList.add('speaking');
    }

    onAvatarStopTalking() {
        // Remove speaking indicator
        this.videoElement?.classList.remove('speaking');
    }

    onSessionClose() {
        this.isAvatarReady = false;
        // Handle session cleanup
    }
}
```

### Complete Integration Example

```javascript
// Import required modules
import StreamingAvatar, { StreamingEvents } from '@heygen/streaming-avatar';

class AgentCAvatarChat {
    constructor(jwtToken) {
        this.agentClient = new AgentCRealtimeClient(jwtToken);
        this.avatarClient = new HeyGenAvatarClient();
        this.setupIntegration();
    }

    setupIntegration() {
        // Handle avatar connection from Agent C
        this.agentClient.on('avatar_connection_changed', async (event) => {
            await this.avatarClient.connectToAvatar(event.avatar_session);
            console.log('Avatar ready for interaction');
        });

        // Handle text deltas with avatar awareness
        this.agentClient.on('text_delta', (event) => {
            this.displayText(event.content);

            // Text is already sent to HeyGen by Agent C API
            // Just update UI to show what avatar will say
        });

        // Handle thinking with avatar feedback
        this.agentClient.on('thought_delta', (event) => {
            this.displayThought(event.content);
            // Avatar automatically says thinking message on first thought
        });
    }

    async startSession(agentKey, avatarId) {
        await this.agentClient.connect();
        await this.agentClient.setupSession(agentKey, avatarId);
        // Avatar connection is automatically established
        // Client receives session data and connects directly to HeyGen
    }

    displayText(content) {
        // Update chat UI with agent response
        const chatArea = document.getElementById('chat-messages');
        chatArea.innerHTML += `<div class="agent-message">${content}</div>`;
    }

    displayThought(content) {
        // Show thinking process in separate area
        const thoughtArea = document.getElementById('agent-thoughts');
        thoughtArea.innerHTML += content;
    }
}
```

## Avatar State Management

### Session States

| State          | Description                  | Actions Available                |
| -------------- | ---------------------------- | -------------------------------- |
| `disconnected` | No avatar session            | Select avatar                    |
| `connecting`   | Establishing HeyGen session  | Wait for connection              |
| `ready`        | Avatar ready for interaction | Send messages                    |
| `speaking`     | Avatar is currently speaking | Wait for completion              |
| `error`        | Connection or session error  | Retry or select different avatar |

### State Transitions

```javascript
class AvatarStateManager {
    constructor() {
        this.state = 'disconnected';
        this.listeners = new Map();
    }

    setState(newState) {
        const oldState = this.state;
        this.state = newState;
        this.notifyListeners(oldState, newState);
    }

    onStateChange(callback) {
        const id = Date.now();
        this.listeners.set(id, callback);
        return id;
    }

    notifyListeners(oldState, newState) {
        this.listeners.forEach(callback => {
            callback(oldState, newState);
        });
    }
}

// Usage
const stateManager = new AvatarStateManager();

stateManager.onStateChange((oldState, newState) => {
    console.log(`Avatar state: ${oldState} â†’ ${newState}`);

    switch (newState) {
        case 'ready':
            enableChatInput();
            break;
        case 'speaking':
            showSpeakingIndicator();
            break;
        case 'error':
            showErrorMessage();
            break;
    }
});
```

## Error Handling and Recovery

### Common HeyGen Errors

| Error                | Cause                        | Resolution                       |
| -------------------- | ---------------------------- | -------------------------------- |
| `session_expired`    | HeyGen session timeout       | Request new session from Agent C |
| `avatar_unavailable` | Avatar not accessible        | Select different avatar          |
| `quota_exceeded`     | HeyGen usage limits          | Wait or upgrade plan             |
| `network_error`      | Connection issues            | Retry with backoff               |
| `invalid_token`      | Access token expired/invalid | Request new avatar session       |
| `websocket_failed`   | WebSocket connection failed  | Check URL format and token       |

### Error Recovery Pattern

```javascript
class RobustAvatarClient extends HeyGenAvatarClient {
    constructor() {
        super();
        this.retryCount = 0;
        this.maxRetries = 3;
    }

    async connectToAvatar(avatarSession) {
        try {
            await super.connectToAvatar(avatarSession);
            this.retryCount = 0; // Reset on success
        } catch (error) {
            await this.handleConnectionError(error, avatarSession);
        }
    }

    async handleConnectionError(error, avatarSession) {
        if (this.retryCount >= this.maxRetries) {
            throw new Error('Max retries exceeded for avatar connection');
        }

        this.retryCount++;
        const delay = Math.pow(2, this.retryCount) * 1000; // Exponential backoff

        console.log(`Avatar connection failed, retrying in ${delay}ms...`);
        await new Promise(resolve => setTimeout(resolve, delay));

        // Request new session from Agent C API
        await this.requestNewAvatarSession(avatarSession.avatar_id);
    }

    async requestNewAvatarSession(avatarId) {
        // Send new set_avatar request to Agent C API
        this.agentClient.sendEvent({
            type: 'set_avatar',
            avatar_id: avatarId
        });
    }
}
```

## Performance Optimization

### Best Practices

1. **Preload Avatars**: Load avatar lists during app initialization
2. **Connection Pooling**: Reuse HeyGen sessions when possible
3. **Bandwidth Management**: Choose appropriate quality settings
4. **Error Boundaries**: Implement graceful degradation
5. **Resource Cleanup**: Properly close sessions and connections

### Bandwidth Optimization

```javascript
class AdaptiveAvatarClient extends HeyGenAvatarClient {
    constructor() {
        super();
        this.connectionQuality = this.detectConnectionQuality();
    }

    detectConnectionQuality() {
        // Use Network Information API if available
        if ('connection' in navigator) {
            const connection = navigator.connection;
            if (connection.effectiveType === '4g') return 'high';
            if (connection.effectiveType === '3g') return 'medium';
            return 'low';
        }
        return 'medium'; // Default fallback
    }

    getOptimalSettings() {
        const settings = {
            low: { quality: 'low', video_encoding: 'VP8' },
            medium: { quality: 'medium', video_encoding: 'VP8' },
            high: { quality: 'high', video_encoding: 'H264' }
        };

        return settings[this.connectionQuality];
    }

    async selectAvatar(avatarId) {
        const settings = this.getOptimalSettings();

        return this.agentClient.sendEvent({
            type: 'set_avatar',
            avatar_id: avatarId,
            ...settings
        });
    }
}
```

## Security Considerations

### Access Token Security

- **One-Time Use**: HeyGen access tokens are one-time use and tied to specific sessions
- **Short-lived**: Access tokens have limited validity (typically session duration)
- **Secure Transmission**: Tokens are transmitted over encrypted WebSocket connections
- **No Client Storage**: Avoid storing access tokens in client-side storage
- **Server-Side Generation**: Agent C API generates fresh tokens server-side using API keys

### Privacy and Compliance

- **Data Processing**: Avatar interactions may be processed by HeyGen
- **User Consent**: Ensure appropriate user consent for avatar interactions
- **Data Retention**: Review HeyGen's data retention policies
- **Regional Compliance**: Consider data locality requirements

## Troubleshooting

### Common Issues

1. **Avatar Not Appearing**
   
   - Check avatar session establishment
   - Verify video element configuration
   - Ensure HeyGen WebSocket connection

2. **Avatar Not Speaking**
   
   - Verify text contains newlines for speech triggers
   - Check HeyGen session token validity
   - Ensure audio permissions are granted

3. **Choppy Video/Audio**
   
   - Reduce quality settings
   - Check network bandwidth
   - Verify browser compatibility

4. **Session Timeouts**
   
   - Implement session refresh logic
   - Monitor connection health
   - Handle reconnection gracefully

### Debug Tools

```javascript
class DebugAvatarClient extends HeyGenAvatarClient {
    constructor() {
        super();
        this.debugMode = true;
    }

    handleHeyGenEvent(event) {
        if (this.debugMode) {
            console.log('ðŸŽ­ HeyGen Event:', {
                type: event.type,
                timestamp: new Date().toISOString(),
                data: event
            });
        }
        super.handleHeyGenEvent(event);
    }

    logSessionInfo(avatarSession) {
        if (this.debugMode) {
            console.log('ðŸŽ­ Avatar Session Info:', {
                session_id: avatarSession.session_id,
                avatar_id: avatarSession.avatar_id,
                quality: avatarSession.quality,
                encoding: avatarSession.video_encoding,
                access_token_length: avatarSession.access_token.length,
                realtime_endpoint: avatarSession.realtime_endpoint
            });
        }
    }
}
```

## Integration Checklist

### Pre-Integration

- [ ] HeyGen API access configured
- [ ] Avatar selection UI implemented
- [ ] Video element prepared in DOM
- [ ] Error handling strategy defined

### During Integration

- [ ] Agent C connection established
- [ ] Avatar session received and processed
- [ ] HeyGen WebSocket connection established
- [ ] Video stream connected to UI element
- [ ] Text delta handling implemented
- [ ] Thought delta handling implemented

### Post-Integration Testing

- [ ] Avatar selection works correctly
- [ ] Speech synchronizes with text
- [ ] Thinking messages appear appropriately
- [ ] Error recovery functions properly
- [ ] Session cleanup works on disconnect
- [ ] Performance meets requirements

This guide provides the foundation for implementing robust HeyGen avatar integration with the Agent C Realtime API. For additional implementation details, refer to the [Integration Guide](realtime_api_integration_guide.md) and [Runtime Events Reference](realtime_api_runtime_events.md).